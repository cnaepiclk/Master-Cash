<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mobcash Ultimate System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* ============================
           CORE STYLES
           ============================ */
        body { margin: 0; font-family: 'Segoe UI', 'Roboto', sans-serif; -webkit-user-select: none; user-select: none; background-color: #f3f4f6; }
        .text-red { color: #d32f2f !important; }
        .text-green { color: #2e7d32 !important; }
        .text-black { color: #000 !important; }
        
        /* ============================
           MAIN MENU
           ============================ */
        #main-menu { 
            background-color: #6200ea; 
            min-height: 100vh; 
            padding: 20px; 
            box-sizing: border-box; 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 15px; 
            align-content: flex-start;
        }
        .app-item { 
            background-color: #ffffff; 
            border-radius: 25px; 
            padding: 10px; 
            display: flex; 
            flex-direction: column; /* Changed to column for text */
            align-items: center; 
            justify-content: center;
            cursor: pointer; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: transform 0.1s;
            height: 170px; 
            overflow: hidden;
            position: relative; /* For overlay buttons */
        }
        .app-item:active { transform: scale(0.95); opacity: 0.9; }
        .menu-img { width: 100%; height: 80%; object-fit: contain; display: block; }
        
        /* NEW STYLES FOR TEXT & BUTTONS */
        .app-label {
            margin-top: 8px;
            font-weight: bold;
            font-size: 14px;
            color: #333;
            text-align: center;
            width: 100%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .add-overlay {
            position: absolute;
            top: 8px;
            right: 8px;
            background-color: #2e7d32; /* Green */
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 18px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            z-index: 10;
        }
        .delete-overlay {
            position: absolute;
            top: 8px;
            right: 8px;
            background-color: #c62828; /* Red */
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            z-index: 10;
        }

        /* ============================
           WALLET (MOBCASH) STYLES - FIXED
           ============================ */
        #wallet-view { display: none; min-height: 100vh; padding: 20px; padding-bottom: 80px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .icon-btn { width: 40px; height: 40px; background: white; border-radius: 12px; display: flex; justify-content: center; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); font-size: 18px; color: #333; cursor: pointer; }
        .page-title { font-size: 18px; font-weight: bold; text-align: center; flex-grow: 1; }
        
        .balance-card { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .epos-label { font-size: 14px; color: #666; margin-bottom: 5px; }
        .main-amount { font-size: 28px; font-weight: 800; margin-bottom: 5px; }
        .sub-balance { font-size: 14px; color: #555; margin-bottom: 15px; }
        .progress-bg { background: #e0e0e0; height: 8px; border-radius: 10px; width: 100%; overflow: hidden; }
        .progress-fill { background: #4c6ef5; height: 100%; width: 0%; border-radius: 10px; transition: width 0.5s ease-in-out; }

        .action-buttons { display: flex; gap: 15px; margin-bottom: 25px; }
        .action-btn { flex: 1; background: white; padding: 15px; border-radius: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; }
        .action-btn i { font-size: 20px; margin-bottom: 8px; }
        .action-btn span { font-size: 14px; font-weight: 500; }
        .btn-green { color: #2e7d32; } .btn-red { color: #c62828; }

        /* --- FIXED TRANSACTION CARD STYLES --- */
        .transaction-item { 
            background: white; 
            border-radius: 15px; 
            padding: 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 10px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.03); 
            cursor: pointer; 
        }
        
        .trans-left-group {
            display: flex;
            align-items: center;
            flex-grow: 1;
        }

        .trans-icon { 
            width: 45px; 
            height: 45px; 
            border-radius: 12px; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            margin-right: 15px; 
            font-size: 18px;
            flex-shrink: 0; 
        }
        .icon-deposit { background: #e8f5e9; color: #2e7d32; }
        .icon-withdraw { background: #ffebee; color: #c62828; }
        
        .trans-details { 
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .trans-id { font-weight: bold; font-size: 15px; display: block; }
        .trans-sub { font-size: 12px; color: #888; margin-top: 3px; display: block; }

        .trans-right-group { 
            text-align: right; 
            min-width: 100px;
        }
        .amount-val { font-weight: bold; font-size: 15px; display: block; margin-bottom: 3px; }
        .amount-date { font-size: 11px; color: #999; display: block; }

        /* ============================
           MASTER CASH STYLES
           ============================ */
        #master-cash-view { display: none; min-height: 100vh; padding: 15px; background: white; box-sizing: border-box; }
        .mc-top-actions { display: flex; gap: 10px; margin-bottom: 20px; }
        .mc-big-btn { flex: 1; padding: 12px; border-radius: 8px; color: white; font-weight: bold; text-align: center; font-size: 16px; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .mc-bg-green { background-color: #2e7d32; } .mc-bg-red { background-color: #c62828; }
        .ledger-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 15px; table-layout: fixed; }
        .ledger-table th { background-color: #e0e0e0; border: 2px solid #000; padding: 10px; font-weight: bold; text-transform: uppercase; width: 50%; }
        .ledger-table td { border: 1px solid #000; padding: 10px 5px; text-align: center; font-weight: 600; height: 35px; vertical-align: middle; }
        .t-row-filled:active { background-color: #f0f0f0; }
        .table-footer td { background-color: #f9f9f9; border: 2px solid #000; font-weight: bold; font-size: 16px; }
        .mc-balance-box { border: 2px solid #000; padding: 15px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 18px; background: #f3f4f6; margin-top: 10px; }

        /* ============================
           OTHER VIEWS (Salary/History)
           ============================ */
        #history-view { display: none; min-height: 100vh; padding: 20px; background-color: #f8f9fa; }
        .summary-box { background: white; border-radius: 20px; padding: 20px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .filter-tabs { display: flex; gap: 15px; margin-bottom: 20px; border-bottom: 1px solid #ddd; padding-bottom: 0; }
        .tab { font-size: 14px; color: #666; padding: 10px 15px; cursor: pointer; position: relative; background: none; border: none; font-weight: 500; }
        .tab.active { color: #4c6ef5; font-weight: bold; }
        .tab.active::after { content: ''; position: absolute; bottom: -1px; left: 0; width: 100%; height: 3px; background-color: #4c6ef5; }
        
        #salary-view { display: none; min-height: 100vh; padding: 20px; background-color: #f3f4f6; }
        .salary-input { width: 100%; padding: 15px; border: none; border-radius: 12px; font-size: 16px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); outline: none; margin-bottom: 15px; box-sizing: border-box; }
        .add-user-btn { background-color: #6200ea; color: white; border: none; padding: 15px; border-radius: 12px; font-weight: bold; cursor: pointer; width: 100%; margin-bottom: 20px; }
        .user-card { background: white; border-radius: 15px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; cursor: pointer; }

        /* MODALS */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 25px; border-radius: 20px; width: 80%; max-width: 300px; text-align: center; }
        .amount-input { width: 100%; padding: 10px; font-size: 20px; border: 2px solid #e0e0e0; border-radius: 10px; margin-bottom: 20px; text-align: center; outline: none; box-sizing: border-box; }
        .modal-btns { display: flex; gap: 10px; margin-top: 10px; }
        .m-btn { flex: 1; padding: 10px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; }
        .btn-confirm { background: #6200ea; color: white; } .btn-cancel { background: #e0e0e0; color: #333; } .btn-delete { background: #ffebee; color: #c62828; }

        /* CALENDARS */
        #calendar-modal, #mc-calendar-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: flex-end; z-index: 2000; }
        .cal-content { background: white; width: 100%; border-top-left-radius: 25px; border-top-right-radius: 25px; padding: 25px; animation: slideUp 0.3s ease-out; max-height: 85vh; overflow-y: auto; box-sizing: border-box; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .cal-month-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; background: #f8f9fa; padding: 10px; border-radius: 12px; }
        .days-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; text-align: center; }
        .day-cell { height: 40px; display: flex; justify-content: center; align-items: center; border-radius: 50%; cursor: pointer; font-size: 14px; }
        .day-cell:hover { background-color: #f0f2f5; }
        .day-cell.selected { background-color: #4c6ef5; color: white; }
        .cal-apply-btn { width: 100%; background-color: #4c6ef5; color: white; padding: 15px; border: none; border-radius: 15px; font-size: 16px; font-weight: bold; margin-top: 20px; cursor: pointer; }
        
        .detail-row { margin-bottom: 15px; text-align: left; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .detail-label { font-size: 12px; color: #666; display: block; }
        .detail-value { font-size: 16px; font-weight: bold; display: block; margin-top: 2px; }
    </style>
</head>
<body>

    <!-- MAIN MENU -->
    <div id="main-menu">
        <div class="app-item" onclick="openMainMobcash()">
            <img src="https://i.postimg.cc/yxnBGHqs/1764182391625-019ac176-d3bf-787a-8860-82612ae998ae.png" class="menu-img" alt="Mobcash">
        </div>
        <div class="app-item" onclick="openSalaryView()">
            <img src="https://i.postimg.cc/wMr4MfLX/1764182484915-019ac178-3ef9-7783-a27a-fe4912b12e2c.png" class="menu-img" alt="Commission">
        </div>
        
        <!-- MODIFIED: Master Cash Button with + Icon -->
        <div class="app-item" onclick="openMasterCash('Master Cash')">
            <div class="add-overlay" onclick="event.stopPropagation(); addNewMenuButton()">+</div>
            <img src="https://i.postimg.cc/mDvBkP6D/Binance-Coin-Analysis-Can-BNB-Price-Hit-800-After-This-Signal-Just-Flashed.webp" class="menu-img" alt="Master Cash">
            <div class="app-label">Master Cash</div>
        </div>
        
        <!-- Dynamic buttons will be appended here via JS -->
    </div>

    <!-- SUB AGENT VIEW -->
    <div id="salary-view">
        <div class="header">
            <div class="icon-btn" onclick="goBackToMain()"><i class="fas fa-arrow-left"></i></div>
            <div class="page-title">Sub Agent Commission</div>
            <div class="icon-btn" style="visibility: hidden;"></div>
        </div>
        <input type="text" id="salary-name" class="salary-input" placeholder="Enter Name">
        <input type="number" id="salary-phone" class="salary-input" placeholder="Enter Phone Number">
        <button class="add-user-btn" onclick="addSalaryUser()">Add Sub Agent</button>
        <div id="salary-user-list"></div>
    </div>

    <!-- WALLET VIEW (MOBCASH) -->
    <div id="wallet-view">
        <div class="header">
            <div class="icon-btn" onclick="exitWallet()"><i class="fas fa-arrow-left"></i></div>
            <div class="page-title" id="wallet-title">ID 1405105</div>
            <div class="icon-btn"><i class="far fa-bell"></i></div>
        </div>
        <div class="balance-card">
            <div class="epos-label">EPOS limit</div>
            <div class="main-amount" id="display-epos">0.00 Re</div>
            <div class="sub-balance" id="display-balance">Balance: 0.00 Re</div>
            <div class="progress-bg"><div class="progress-fill" id="progress-bar"></div></div>
        </div>
        <div class="action-buttons">
            <div class="action-btn btn-green" onclick="openAddModal('deposit')"><i class="fas fa-arrow-down"></i><span>Deposit</span></div>
            <div class="action-btn btn-red" onclick="openAddModal('withdraw')"><i class="fas fa-arrow-up"></i><span>Withdraw</span></div>
        </div>
        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
            <span style="font-weight:bold;">Recent transactions</span>
            <i class="fas fa-external-link-alt" style="color: #4c6ef5; cursor: pointer;" onclick="openHistory()"></i>
        </div>
        <div id="wallet-trans-list"></div>
    </div>

    <!-- HISTORY VIEW -->
    <div id="history-view">
        <div class="header">
            <div class="icon-btn" onclick="closeHistory()"><i class="fas fa-arrow-left"></i></div>
            <div class="page-title" id="history-active-date">Today</div>
            <div class="icon-btn" onclick="openCalendar()"><i class="far fa-calendar-alt"></i></div>
        </div>
        <div class="summary-box">
            <div style="text-align:center; flex:1;"><div class="text-green"><i class="fas fa-arrow-down"></i> Deposit</div><div class="text-green" style="font-size:18px; font-weight:bold;" id="total-deposit">0.00</div></div>
            <div style="width:1px; height:40px; background:#eee;"></div>
            <div style="text-align:center; flex:1;"><div class="text-red"><i class="fas fa-arrow-up"></i> Withdrawal</div><div class="text-red" style="font-size:18px; font-weight:bold;" id="total-withdraw">0.00</div></div>
        </div>
        <div class="filter-tabs">
            <button class="tab active" onclick="setFilter('all', this)">All</button>
            <button class="tab" onclick="setFilter('deposit', this)">Deposits</button>
            <button class="tab" onclick="setFilter('withdraw', this)">Withdrawals</button>
        </div>
        <div id="history-trans-list"></div>
    </div>

    <!-- MASTER CASH VIEW -->
    <div id="master-cash-view">
        <div class="header">
            <div class="icon-btn" onclick="exitMasterCash()"><i class="fas fa-arrow-left"></i></div>
            <div class="page-title" id="mc-page-title">Master Cash</div>
            <div class="icon-btn" onclick="openMCCalendar()"><i class="far fa-calendar-alt"></i></div>
        </div>
        <div style="text-align: center; margin-bottom: 10px; font-weight: bold; color: #555;" id="mc-current-date-display">Today</div>
        <div class="mc-top-actions">
            <div class="mc-big-btn mc-bg-green" onclick="openMCAddModal('deposit')">Deposit (+)</div>
            <div class="mc-big-btn mc-bg-red" onclick="openMCAddModal('withdraw')">Withdraw (-)</div>
        </div>
        <table class="ledger-table">
            <thead><tr><th>DEPOSIT</th><th>WITHDRAW</th></tr></thead>
            <tbody id="mc-ledger-body"></tbody>
            <tfoot class="table-footer">
                <tr><td class="text-green" id="mc-total-dep-display">0</td><td class="text-red" id="mc-total-with-display">0</td></tr>
            </tfoot>
        </table>
        <div class="mc-balance-box">
            <span>Balance:</span><span id="mc-ledger-balance">0 Re</span>
        </div>
    </div>

    <!-- MOBCASH MODALS -->
    <div id="add-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="page-title" id="add-modal-title">Enter Amount</div>
            <input type="number" class="amount-input" id="add-amount-input" placeholder="0.00">
            <div class="modal-btns">
                <button class="m-btn btn-cancel" onclick="closeAddModal()">Cancel</button>
                <button class="m-btn btn-confirm" onclick="processTransaction()">Confirm</button>
            </div>
        </div>
    </div>

    <div id="edit-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="page-title">Edit Transaction</div>
            <input type="number" class="amount-input" id="edit-amount-input">
            <div class="modal-btns"><button class="m-btn btn-delete" onclick="deleteTransaction()">Delete</button></div>
            <div class="modal-btns">
                <button class="m-btn btn-cancel" onclick="closeEditModal()">Cancel</button>
                <button class="m-btn btn-confirm" onclick="saveEditTransaction()">Save</button>
            </div>
        </div>
    </div>

    <div id="calendar-modal">
        <div class="cal-content">
            <div class="cal-header"><div class="icon-btn" onclick="closeCalendar()"><i class="fas fa-arrow-left"></i></div><span style="font-size:18px; font-weight:bold;">Select Date</span><div></div></div>
            <div class="cal-month-nav">
                <div style="padding:5px 15px;" onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></div>
                <div id="cal-month-year" style="font-weight:bold;">--</div>
                <div style="padding:5px 15px;" onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></div>
            </div>
            <div class="days-grid" id="days-container"></div>
            <button class="cal-apply-btn" onclick="applyDateFilter()">Apply</button>
        </div>
    </div>

    <!-- MASTER CASH MODALS -->
    <div id="mc-add-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="page-title" style="margin-bottom: 15px;" id="mc-add-modal-title">Enter Amount</div>
            <input type="number" class="amount-input" id="mc-add-amount-input" placeholder="0.00">
            <div class="modal-btns">
                <button class="m-btn btn-cancel" onclick="closeMCAddModal()">Cancel</button>
                <button class="m-btn btn-confirm" onclick="processMCTransaction()">Confirm</button>
            </div>
        </div>
    </div>

    <div id="mc-details-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Details</h3>
            <div class="detail-row"><span class="detail-label">Time</span><span class="detail-value" id="mc-detail-time">--</span></div>
            <div class="detail-row"><span class="detail-label">Type</span><span class="detail-value" id="mc-detail-type">--</span></div>
            <div class="detail-row"><span class="detail-label">Amount</span><span class="detail-value" id="mc-detail-amount" style="font-size: 24px;">--</span></div>
            <div class="modal-btns">
                <button class="m-btn" style="background:#e3f2fd; color:#1565c0;" onclick="switchToMCEdit()">Edit</button>
                <button class="m-btn btn-delete" onclick="deleteMCTransaction()">Delete</button>
            </div>
            <div class="modal-btns" style="margin-top:5px;"><button class="m-btn btn-cancel" onclick="closeMCDetailsModal()">Close</button></div>
        </div>
    </div>

    <div id="mc-edit-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="page-title" style="margin-bottom: 15px;">Edit Amount</div>
            <input type="number" class="amount-input" id="mc-edit-amount-input">
            <div class="modal-btns">
                <button class="m-btn btn-cancel" onclick="closeMCEditModal()">Cancel</button>
                <button class="m-btn btn-confirm" onclick="saveMCEditTransaction()">Save</button>
            </div>
        </div>
    </div>

    <div id="mc-calendar-modal">
        <div class="cal-content">
            <div class="cal-header"><div class="icon-btn" onclick="closeMCCalendar()"><i class="fas fa-arrow-left"></i></div><span style="font-size:18px; font-weight:bold;">Select Date (MC)</span><div></div></div>
            <div class="cal-month-nav">
                <div style="padding:5px 15px;" onclick="changeMCMonth(-1)"><i class="fas fa-chevron-left"></i></div>
                <div id="mc-cal-month-year" style="font-weight:bold;">--</div>
                <div style="padding:5px 15px;" onclick="changeMCMonth(1)"><i class="fas fa-chevron-right"></i></div>
            </div>
            <div class="days-grid" id="mc-days-container"></div>
            <button class="cal-apply-btn" onclick="applyMCDateFilter()">Show History</button>
        </div>
    </div>

    <!-- JAVASCRIPT -->
    <script>
        // ==========================================
        // 1. SHARED & MOBCASH LOGIC
        // ==========================================
        let mainMobcashTransactions = []; 
        let salaryUsers = []; 
        let activeContextId = null;
        let activeFilterDateKey = formatDateKey(new Date());
        let activeTab = 'all';
        let editingTransactionId = null;

        let tempSelectedDate = new Date();
        let calMonth = new Date().getMonth();
        let calYear = new Date().getFullYear();

        // CUSTOM MENU LOGIC
        let customMenuItems = [];

        window.onload = function() {
            loadAllData(); 
            loadMasterCashData();
            loadCustomMenu(); // Load new buttons
        }

        function loadAllData() {
            const mainSaved = localStorage.getItem('mobcash_pro_data_v4');
            if (mainSaved) mainMobcashTransactions = JSON.parse(mainSaved);
            const salarySaved = localStorage.getItem('mobcash_salary_data');
            if (salarySaved) salaryUsers = JSON.parse(salarySaved);
        }
        function saveMainData() { localStorage.setItem('mobcash_pro_data_v4', JSON.stringify(mainMobcashTransactions)); }
        function saveSalaryData() { localStorage.setItem('mobcash_salary_data', JSON.stringify(salaryUsers)); }

        function getCurrentTransactions() {
            if (activeContextId === null) return mainMobcashTransactions;
            const user = salaryUsers.find(u => u.id === activeContextId);
            return user ? user.transactions : [];
        }

        function saveCurrentTransactions(updatedTransArray) {
            if (activeContextId === null) {
                mainMobcashTransactions = updatedTransArray;
                saveMainData();
            } else {
                const index = salaryUsers.findIndex(u => u.id === activeContextId);
                if (index !== -1) {
                    salaryUsers[index].transactions = updatedTransArray;
                    saveSalaryData();
                    renderSalaryUsers();
                }
            }
        }

        // --- CUSTOM MENU FUNCTIONS (NEW) ---
        function addNewMenuButton() {
            const name = prompt("Enter Name for new button:");
            if (name && name.trim() !== "") {
                const newItem = {
                    id: Date.now().toString(),
                    name: name.trim()
                };
                customMenuItems.push(newItem);
                saveCustomMenu();
                renderCustomMenu();
            }
        }

        function saveCustomMenu() {
            localStorage.setItem('mobcash_custom_menu_v1', JSON.stringify(customMenuItems));
        }

        function loadCustomMenu() {
            const saved = localStorage.getItem('mobcash_custom_menu_v1');
            if (saved) {
                customMenuItems = JSON.parse(saved);
            }
            renderCustomMenu();
        }

        function renderCustomMenu() {
            // Remove existing dynamic items first (all items after the 3rd static one)
            const menu = document.getElementById('main-menu');
            // We keep the first 3 items (Mobcash, Salary, Master Cash)
            // The static items have index 0, 1, 2
            
            // Simple way: remove all elements with class 'dynamic-item'
            const dynamics = document.querySelectorAll('.dynamic-item');
            dynamics.forEach(el => el.remove());

            // Append new ones
            customMenuItems.forEach(item => {
                const div = document.createElement('div');
                div.className = 'app-item dynamic-item';
                div.onclick = function() { openMasterCash(item.name); }; // Opens generic view with custom name
                
                div.innerHTML = `
                    <div class="delete-overlay" onclick="event.stopPropagation(); deleteCustomButton('${item.id}')"><i class="fas fa-minus"></i></div>
                    <img src="https://i.postimg.cc/mDvBkP6D/Binance-Coin-Analysis-Can-BNB-Price-Hit-800-After-This-Signal-Just-Flashed.webp" class="menu-img" alt="${item.name}">
                    <div class="app-label">${item.name}</div>
                `;
                menu.appendChild(div);
            });
        }

        function deleteCustomButton(id) {
            if(confirm("Are you sure you want to delete this button?")) {
                customMenuItems = customMenuItems.filter(item => item.id !== id);
                saveCustomMenu();
                renderCustomMenu();
            }
        }

        // NAVIGATION
        function openMainMobcash() {
            activeContextId = null;
            document.getElementById('wallet-title').innerText = "ID 1405105";
            document.getElementById('main-menu').style.display = 'none';
            document.getElementById('wallet-view').style.display = 'block';
            updateWalletUI();
        }
        function openSalaryView() {
            document.getElementById('main-menu').style.display = 'none';
            document.getElementById('salary-view').style.display = 'block';
            renderSalaryUsers();
        }
        function goBackToMain() {
            document.getElementById('salary-view').style.display = 'none';
            document.getElementById('wallet-view').style.display = 'none';
            document.getElementById('master-cash-view').style.display = 'none';
            document.getElementById('main-menu').style.display = 'grid';
        }
        function exitWallet() {
            document.getElementById('wallet-view').style.display = 'none';
            if (activeContextId === null) document.getElementById('main-menu').style.display = 'grid';
            else document.getElementById('salary-view').style.display = 'block';
        }

        // SALARY FUNCTIONS
        function addSalaryUser() {
            const name = document.getElementById('salary-name').value;
            const phone = document.getElementById('salary-phone').value;
            if(!name || !phone) { alert("Please enter Name and Phone"); return; }
            const newUser = { id: Date.now().toString(), name: name, phone: phone, transactions: [] };
            salaryUsers.unshift(newUser);
            saveSalaryData();
            renderSalaryUsers();
            document.getElementById('salary-name').value = '';
            document.getElementById('salary-phone').value = '';
        }
        function deleteUser(id) {
            if(!confirm("Delete this user?")) return;
            salaryUsers = salaryUsers.filter(u => u.id !== id);
            saveSalaryData();
            renderSalaryUsers();
        }
        function openUserWallet(id) {
            activeContextId = id;
            const user = salaryUsers.find(u => u.id === id);
            document.getElementById('wallet-title').innerText = user.name;
            document.getElementById('salary-view').style.display = 'none';
            document.getElementById('wallet-view').style.display = 'block';
            updateWalletUI();
        }
        function renderSalaryUsers() {
            const list = document.getElementById('salary-user-list');
            list.innerHTML = '';
            salaryUsers.forEach(user => {
                let totalDep = 0; let totalWith = 0;
                user.transactions.forEach(t => { if(t.type === 'deposit') totalDep += t.amount; else totalWith += t.amount; });
                const card = `<div class="user-card" onclick="openUserWallet('${user.id}')">
                    <div><div style="font-weight:bold;">${user.name}</div><div style="font-size:13px; color:#888;">${user.phone}</div>
                    <div style="font-size:13px; font-weight:600;"><span class="text-green">Dep: ${formatMoney(totalDep)}</span> | <span class="text-red">With: ${formatMoney(totalWith)}</span></div></div>
                    <div onclick="event.stopPropagation(); deleteUser('${user.id}')" style="color:#c62828; padding:10px;"><i class="fas fa-trash-alt"></i></div></div>`;
                list.innerHTML += card;
            });
        }

        // WALLET UI & ACTIONS
        function updateWalletUI() {
            const currentTrans = getCurrentTransactions();
            let balance = 0;
            currentTrans.forEach(t => { if (t.type === 'deposit') balance += t.amount; else balance -= t.amount; });
            const formatted = formatMoney(balance) + " Re";
            document.getElementById('display-balance').innerHTML = `Balance: ${formatted}`;
            document.getElementById('display-epos').innerText = formatted;
            let percentage = (balance / 200000) * 100;
            if (percentage < 0) percentage = 0; if (percentage > 100) percentage = 100;
            document.getElementById('progress-bar').style.width = percentage + "%";
            const list = document.getElementById('wallet-trans-list');
            list.innerHTML = '';
            currentTrans.slice(0, 5).forEach(t => list.innerHTML += createTransHTML(t));
        }

        function openHistory() { 
            document.getElementById('wallet-view').style.display = 'none'; 
            document.getElementById('history-view').style.display = 'block'; 
            renderHistory(); 
        }
        function closeHistory() { 
            document.getElementById('history-view').style.display = 'none'; 
            document.getElementById('wallet-view').style.display = 'block'; 
            updateWalletUI();
        }
        function setFilter(type, btn) {
            activeTab = type;
            document.querySelectorAll('.filter-tabs .tab').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            renderHistory();
        }
        function renderHistory() {
            const currentTrans = getCurrentTransactions();
            const dayTransactions = currentTrans.filter(t => t.dateString === activeFilterDateKey);
            let dayDep = 0, dayWith = 0;
            dayTransactions.forEach(t => { if(t.type === 'deposit') dayDep += t.amount; else dayWith += t.amount; });
            document.getElementById('history-active-date').innerText = activeFilterDateKey === formatDateKey(new Date()) ? "Today" : activeFilterDateKey;
            document.getElementById('total-deposit').innerText = formatMoney(dayDep);
            document.getElementById('total-withdraw').innerText = formatMoney(dayWith);
            let listToShow = dayTransactions;
            if(activeTab === 'deposit') listToShow = dayTransactions.filter(t => t.type === 'deposit');
            else if (activeTab === 'withdraw') listToShow = dayTransactions.filter(t => t.type === 'withdraw');
            const list = document.getElementById('history-trans-list');
            list.innerHTML = '';
            listToShow.forEach(t => list.innerHTML += createTransHTML(t));
        }

        function openAddModal(type) {
            window.currentType = type;
            document.getElementById('add-modal-title').innerText = type === 'deposit' ? 'Deposit Amount' : 'Withdraw Amount';
            document.getElementById('add-amount-input').value = '';
            document.getElementById('add-modal').style.display = 'flex';
            document.getElementById('add-amount-input').focus();
        }
        function closeAddModal() { document.getElementById('add-modal').style.display = 'none'; }
        function processTransaction() {
            const amount = parseFloat(document.getElementById('add-amount-input').value);
            if (isNaN(amount) || amount <= 0) { alert("Valid amount required"); return; }
            const now = new Date();
            const newTrans = {
                uuid: Date.now() + Math.random().toString(36).substr(2, 9),
                type: window.currentType, amount: amount, 
                id: Math.floor(Math.random() * 1000),
                longId: Math.floor(1000000000 + Math.random() * 9000000000),
                dateString: formatDateKey(now), timeString: formatTime(now), timestamp: now.getTime()
            };
            let currentTrans = getCurrentTransactions();
            currentTrans.unshift(newTrans);
            saveCurrentTransactions(currentTrans);
            updateWalletUI();
            closeAddModal();
        }
        function openEditModal(uuid) {
            const currentTrans = getCurrentTransactions();
            const trans = currentTrans.find(t => t.uuid === uuid);
            if (!trans) return;
            editingTransactionId = uuid;
            document.getElementById('edit-amount-input').value = trans.amount;
            document.getElementById('edit-modal').style.display = 'flex';
        }
        function closeEditModal() { document.getElementById('edit-modal').style.display = 'none'; editingTransactionId = null; }
        function saveEditTransaction() {
            const newAmount = parseFloat(document.getElementById('edit-amount-input').value);
            if (isNaN(newAmount) || newAmount <= 0) return;
            let currentTrans = getCurrentTransactions();
            const transIndex = currentTrans.findIndex(t => t.uuid === editingTransactionId);
            if (transIndex !== -1) {
                currentTrans[transIndex].amount = newAmount;
                saveCurrentTransactions(currentTrans);
                updateWalletUI();
                closeEditModal();
                if(document.getElementById('history-view').style.display === 'block') renderHistory();
            }
        }
        function deleteTransaction() {
            if(!confirm("Are you sure?")) return;
            let currentTrans = getCurrentTransactions();
            currentTrans = currentTrans.filter(t => t.uuid !== editingTransactionId);
            saveCurrentTransactions(currentTrans);
            updateWalletUI();
            closeEditModal();
            if(document.getElementById('history-view').style.display === 'block') renderHistory();
        }

        function openCalendar() {
            document.getElementById('calendar-modal').style.display = 'flex';
            const parts = activeFilterDateKey.split('.');
            tempSelectedDate = new Date(parts[2], parts[1]-1, parts[0]);
            calMonth = tempSelectedDate.getMonth(); calYear = tempSelectedDate.getFullYear();
            renderCalendar(document.getElementById('days-container'), document.getElementById('cal-month-year'));
        }
        function closeCalendar() { document.getElementById('calendar-modal').style.display = 'none'; }
        function changeMonth(dir) {
            calMonth += dir;
            if(calMonth > 11) { calMonth = 0; calYear++; } else if (calMonth < 0) { calMonth = 11; calYear--; }
            renderCalendar(document.getElementById('days-container'), document.getElementById('cal-month-year'));
        }
        function applyDateFilter() { activeFilterDateKey = formatDateKey(tempSelectedDate); renderHistory(); closeCalendar(); }

        // ==========================================
        // 2. MASTER CASH LOGIC
        // ==========================================
        let masterCashTransactions = [];
        let mcActiveDateKey = formatDateKey(new Date());
        let mcEditingUuid = null;
        let mcCurrentType = 'deposit';
        let mcTempSelectedDate = new Date();
        let mcCalMonth = new Date().getMonth();
        let mcCalYear = new Date().getFullYear();

        // Modified to accept a custom Title
        function openMasterCash(title = "Master Cash") {
            document.getElementById('mc-page-title').innerText = title;
            document.getElementById('main-menu').style.display = 'none';
            document.getElementById('master-cash-view').style.display = 'block';
            renderMCTable();
        }
        function exitMasterCash() {
            document.getElementById('master-cash-view').style.display = 'none';
            document.getElementById('main-menu').style.display = 'grid';
        }
        function loadMasterCashData() {
            const saved = localStorage.getItem('master_cash_data_v2');
            masterCashTransactions = saved ? JSON.parse(saved) : [];
        }
        function saveMasterCashData() { localStorage.setItem('master_cash_data_v2', JSON.stringify(masterCashTransactions)); }

        function renderMCTable() {
            const dayTrans = masterCashTransactions.filter(t => t.dateString === mcActiveDateKey);
            dayTrans.sort((a, b) => a.timestamp - b.timestamp);
            const tbody = document.getElementById('mc-ledger-body');
            tbody.innerHTML = '';
            let totalDep = 0; let totalWith = 0;
            document.getElementById('mc-current-date-display').innerText = (mcActiveDateKey === formatDateKey(new Date())) ? "Today" : mcActiveDateKey;
            dayTrans.forEach(t => {
                const tr = document.createElement('tr');
                tr.className = 't-row-filled';
                tr.onclick = () => openMCDetailsModal(t.uuid);
                if(t.type === 'deposit') {
                    totalDep += t.amount;
                    tr.innerHTML = `<td class="text-black">${formatMoney(t.amount)}</td><td></td>`;
                } else {
                    totalWith += t.amount;
                    tr.innerHTML = `<td></td><td class="text-black">${formatMoney(t.amount)}</td>`;
                }
                tbody.appendChild(tr);
            });
            document.getElementById('mc-total-dep-display').innerText = formatMoney(totalDep);
            document.getElementById('mc-total-with-display').innerText = formatMoney(totalWith);
            const balance = totalDep - totalWith;
            const balEl = document.getElementById('mc-ledger-balance');
            balEl.innerText = formatMoney(balance) + " Re";
            balEl.className = balance < 0 ? "text-red" : "text-black";
        }
        function openMCAddModal(type) {
            mcCurrentType = type;
            document.getElementById('mc-add-modal-title').innerText = type === 'deposit' ? 'Add Deposit (+)' : 'Add Withdraw (-)';
            document.getElementById('mc-add-amount-input').value = '';
            document.getElementById('mc-add-modal').style.display = 'flex';
            document.getElementById('mc-add-amount-input').focus();
        }
        function closeMCAddModal() { document.getElementById('mc-add-modal').style.display = 'none'; }
        function processMCTransaction() {
            const amt = parseFloat(document.getElementById('mc-add-amount-input').value);
            if(isNaN(amt) || amt <= 0) { alert("Invalid amount"); return; }
            const now = new Date();
            const newT = {
                uuid: Date.now() + Math.random().toString(36).substr(2, 9),
                type: mcCurrentType, amount: amt, dateString: mcActiveDateKey,
                timeString: formatTime(now), timestamp: now.getTime()
            };
            masterCashTransactions.push(newT);
            saveMasterCashData();
            closeMCAddModal();
            renderMCTable();
        }
        function openMCDetailsModal(uuid) {
            const t = masterCashTransactions.find(x => x.uuid === uuid);
            if(!t) return;
            mcEditingUuid = uuid;
            document.getElementById('mc-detail-time').innerText = `${t.dateString} - ${t.timeString}`;
            document.getElementById('mc-detail-type').innerText = t.type.toUpperCase();
            const amtEl = document.getElementById('mc-detail-amount');
            amtEl.innerText = formatMoney(t.amount);
            amtEl.className = t.type === 'deposit' ? 'detail-value text-green' : 'detail-value text-red';
            document.getElementById('mc-details-modal').style.display = 'flex';
        }
        function closeMCDetailsModal() { document.getElementById('mc-details-modal').style.display = 'none'; }
        function switchToMCEdit() {
            closeMCDetailsModal();
            const t = masterCashTransactions.find(x => x.uuid === mcEditingUuid);
            if(t) {
                document.getElementById('mc-edit-amount-input').value = t.amount;
                document.getElementById('mc-edit-modal').style.display = 'flex';
            }
        }
        function closeMCEditModal() { document.getElementById('mc-edit-modal').style.display = 'none'; }
        function saveMCEditTransaction() {
            const newAmt = parseFloat(document.getElementById('mc-edit-amount-input').value);
            if(isNaN(newAmt) || newAmt <= 0) return;
            const idx = masterCashTransactions.findIndex(x => x.uuid === mcEditingUuid);
            if(idx !== -1) {
                masterCashTransactions[idx].amount = newAmt;
                saveMasterCashData();
                closeMCEditModal();
                renderMCTable();
            }
        }
        function deleteMCTransaction() {
            if(!confirm("Delete this entry?")) return;
            masterCashTransactions = masterCashTransactions.filter(x => x.uuid !== mcEditingUuid);
            saveMasterCashData();
            closeMCDetailsModal();
            renderMCTable();
        }
        function openMCCalendar() {
            document.getElementById('mc-calendar-modal').style.display = 'flex';
            const parts = mcActiveDateKey.split('.');
            mcTempSelectedDate = new Date(parts[2], parts[1]-1, parts[0]);
            mcCalMonth = mcTempSelectedDate.getMonth(); mcCalYear = mcTempSelectedDate.getFullYear();
            renderMCCalendar();
        }
        function closeMCCalendar() { document.getElementById('mc-calendar-modal').style.display = 'none'; }
        function changeMCMonth(d) {
            mcCalMonth += d;
            if(mcCalMonth > 11) { mcCalMonth = 0; mcCalYear++; } else if (mcCalMonth < 0) { mcCalMonth = 11; mcCalYear--; }
            renderMCCalendar();
        }
        function renderMCCalendar() {
            const con = document.getElementById('mc-days-container'); con.innerHTML = '';
            const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
            document.getElementById('mc-cal-month-year').innerText = `${months[mcCalMonth]} ${mcCalYear}`;
            const firstDay = new Date(mcCalYear, mcCalMonth, 1).getDay();
            const daysInMonth = new Date(mcCalYear, mcCalMonth+1, 0).getDate();
            for(let i=0; i<firstDay; i++) con.innerHTML += '<div class="day-cell"></div>';
            for(let i=1; i<=daysInMonth; i++) {
                const div = document.createElement('div'); div.className = 'day-cell'; div.innerText = i;
                if(i === mcTempSelectedDate.getDate() && mcCalMonth === mcTempSelectedDate.getMonth() && mcCalYear === mcTempSelectedDate.getFullYear()) div.classList.add('selected');
                div.onclick = () => { mcTempSelectedDate = new Date(mcCalYear, mcCalMonth, i); renderMCCalendar(); };
                con.appendChild(div);
            }
        }
        function applyMCDateFilter() { mcActiveDateKey = formatDateKey(mcTempSelectedDate); closeMCCalendar(); renderMCTable(); }

        // ==========================================
        // UTILS (FIXED FOR CARDS)
        // ==========================================
        function renderCalendar(container, titleEl) {
            container.innerHTML = '';
            const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
            titleEl.innerText = `${months[calMonth]} ${calYear}`;
            const firstDay = new Date(calYear, calMonth, 1).getDay();
            const daysInMonth = new Date(calYear, calMonth + 1, 0).getDate();
            for(let i=0; i<firstDay; i++) container.innerHTML += '<div class="day-cell"></div>';
            for(let i=1; i<=daysInMonth; i++) {
                const cell = document.createElement('div'); cell.className = 'day-cell'; cell.innerText = i;
                if(i === tempSelectedDate.getDate() && calMonth === tempSelectedDate.getMonth() && calYear === tempSelectedDate.getFullYear()) cell.classList.add('selected');
                cell.onclick = function() { tempSelectedDate = new Date(calYear, calMonth, i); renderCalendar(container, titleEl); };
                container.appendChild(cell);
            }
        }
        
        function createTransHTML(t) {
            const isDep = t.type === 'deposit';
            const shortId = t.id || Math.floor(Math.random() * 1000);
            const longId = t.longId || Math.floor(1000000000 + Math.random() * 9000000000);

            return `
            <div class="transaction-item" onclick="openEditModal('${t.uuid}')">
                <div class="trans-left-group">
                    <div class="trans-icon ${isDep ? 'icon-deposit' : 'icon-withdraw'}">
                        <i class="fas ${isDep ? 'fa-arrow-down' : 'fa-arrow-up'}"></i>
                    </div>
                    <div class="trans-details">
                        <div class="trans-id">â„–...${shortId}</div>
                        <div class="trans-sub">ID ${longId}</div>
                    </div>
                </div>
                <div class="trans-right-group">
                    <div class="amount-val ${isDep ? 'text-green' : 'text-black'}">
                        ${isDep ? '+' : ''}${t.type === 'withdraw' ? '-' : ''}${formatMoney(t.amount)} Re
                    </div>
                    <div class="amount-date">${t.dateString} / ${t.timeString}</div>
                </div>
            </div>`;
        }
        
        function formatMoney(n) { return n.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}); }
        function pad(n) { return n < 10 ? '0'+n : n; }
        function formatDateKey(date) { return `${pad(date.getDate())}.${pad(date.getMonth()+1)}.${date.getFullYear()}`; }
        function formatTime(date) { return `${pad(date.getHours())}:${pad(date.getMinutes())}:${pad(date.getSeconds())}`; }
    </script>
</body>
</html>
